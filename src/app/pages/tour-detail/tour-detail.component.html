<app-navbar></app-navbar>
<section class="tour-detail" *ngIf="tour">
  <div class="hero-section">
    <img [src]="tour.image_url" alt="{{ tour.title }}" class="hero-image" />
    <div class="hero-overlay">
      <div class="container">
        <div class="hero-content">
          <h1 class="tour-title">{{ tour.title }}</h1>
          <div class="tour-meta">
            <span class="destination" *ngIf="tour.destination_title">{{ tour.destination_title }}</span>
            <span class="duration">{{ tour.duration_days }} Days</span>
            <span class="availability">{{ getAvailabilityText() }}</span>
            <span class="difficulty" *ngIf="tour.difficulty_level">{{ tour.difficulty_level }}</span>
            <span class="category" *ngIf="tour.category">{{ tour.category | titlecase }}</span>
          </div>
          <div class="airports" *ngIf="tour.departure_airport || tour.arrival_airport">
            <div class="airport-info" *ngIf="tour.departure_airport">
              <i class="icon-plane"></i>
              <span>Departure: {{ tour.departure_airport }}</span>
            </div>
            <div class="airport-info" *ngIf="tour.arrival_airport">
              <i class="icon-plane"></i>
              <span>Arrival: {{ tour.arrival_airport }}</span>
            </div>
          </div>
          <div class="group-size" *ngIf="tour.min_group_size || tour.max_group_size">
            <i class="icon-users"></i>
            <span>{{ tour.min_group_size || 1 }} - {{ tour.max_group_size }} Guests</span>
          </div>
          <div class="customizable" *ngIf="tour.is_customizable">
            <i class="icon-check"></i>
            <span>Customizable Tour</span>
          </div>
          <div class="status" *ngIf="tour.is_active != null">
            <i class="icon-check"></i>
            <span>{{ tour.is_active ? 'Active' : 'Inactive' }}</span>
          </div>
          <div class="featured" *ngIf="tour.is_featured">
            <i class="icon-star"></i>
            <span>Featured Tour</span>
          </div>
        </div>
        <div class="booking-card">
          <div class="price-section">
            <span class="price-label">Price per Person</span>
            <span class="price">{{ tour.price_currency || 'INR' }} {{ formatPrice(tour.price_per_person || tour.price) }}</span>
            <span class="discount" *ngIf="tour.early_bird_discount">Early Bird: {{ formatDiscount(tour.early_bird_discount) }} off</span>
            <span class="discount" *ngIf="tour.group_discount">Group: {{ formatDiscount(tour.group_discount) }} off</span>
            <span class="advance-booking" *ngIf="tour.advance_booking_days">Book {{ tour.advance_booking_days }} days in advance</span>
          </div>
          <!-- <div class="booking-details">
            <div class="detail-item" *ngIf="tour.adults != null">
              <strong>Adults:</strong> {{ tour.adults }}
            </div>
            <div class="detail-item" *ngIf="tour.children != null">
              <strong>Children:</strong> {{ tour.children }}
            </div>
            <div class="detail-item" *ngIf="tour.rooms != null">
              <strong>Rooms:</strong> {{ tour.rooms }}
            </div>
          </div> -->
          <div class="booking-forms">
            <button class="btn btn-outline" (click)="openEnquiryForm()">Enquiry Form</button>
            <button class="btn btn-primary" (click)="openBookingForm()">Book Now</button>
          </div>
          <button class="btn btn-success btn-full" (click)="proceedBooking()">PROCEED BOOKING</button>
          <div class="action-buttons">
            <button class="btn btn-link" (click)="saveToWishlist()">Save To Wish List</button>
            <button class="btn btn-link" (click)="viewReviews()">Reviews</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="detail-tabs">
      <button class="tab-btn" [class.active]="activeTab === 'overview'" (click)="setActiveTab('overview')">Details</button>
      <button class="tab-btn" [class.active]="activeTab === 'itinerary'" (click)="setActiveTab('itinerary')">Itinerary</button>
      <button class="tab-btn" [class.active]="activeTab === 'map'" (click)="setActiveTab('map')">Map</button>
      <button class="tab-btn" [class.active]="activeTab === 'photos'" (click)="setActiveTab('photos')">Photos</button>
      <button class="tab-btn" [class.active]="activeTab === 'reviews'" (click)="setActiveTab('reviews')">Reviews</button>
      <button class="tab-btn" [class.active]="activeTab === 'info'" (click)="setActiveTab('info')">Additional Info</button>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'overview'">
      <div class="overview-section">
        <h2>OVERVIEW</h2>
        <div class="description">
          <p>{{ tour.description || 'No description available' }}</p>
        </div>
        <div class="details-grid">
          <div class="detail-item" *ngIf="tour.category === 'group' && tour.departures?.length">
            <strong>Departures:</strong>
            <ul>
              <li *ngFor="let departure of tour.departures">
                {{ departure.departure_date | date: 'mediumDate' }} - {{ departure.available_seats }} seats available
              </li>
            </ul>
          </div>
          <div class="detail-item" *ngIf="tour.category === 'holiday'">
            <strong>Available From:</strong> {{ tour.available_from | date: 'mediumDate' }}
          </div>
          <div class="detail-item" *ngIf="tour.category === 'holiday'">
            <strong>Available To:</strong> {{ tour.available_to | date: 'mediumDate' }}
          </div>
          <div class="detail-item" *ngIf="tour.category === 'holiday' && (tour.min_group_size || tour.max_group_size)">
            <strong>Group Size:</strong> {{ tour.min_group_size || 1 }} - {{ tour.max_group_size }} Guests
          </div>
          <div class="detail-item" *ngIf="tour.accommodation_type">
            <strong>Accommodation Type:</strong> {{ tour.accommodation_type }}
            <span class="rating" *ngIf="tour.accommodation_rating">
              <span *ngFor="let star of getAccommodationRatingStars()">★</span>
            </span>
          </div>
          <div class="detail-item" *ngIf="tour.guide_included != null">
            <strong>Guide:</strong> {{ tour.guide_included ? 'Included' : 'Not Included' }}
            <span *ngIf="tour.guide_languages?.length"> (Languages: {{ tour.guide_languages?.join(', ') }})</span>
          </div>
          <div class="detail-item" *ngIf="tour.transportation_included != null">
            <strong>Transportation:</strong> {{ tour.transportation_included ? tour.transportation_details || 'Included' : 'Not Included' }}
          </div>
          <div class="detail-item" *ngIf="tour.activity_types?.length">
            <strong>Activities:</strong> {{ tour.activity_types?.join(', ') }}
          </div>
          <div class="detail-item" *ngIf="tour.interests?.length">
            <strong>Interests:</strong> {{ tour.interests?.join(', ') }}
          </div>
          <div class="detail-item" *ngIf="tour.physical_requirements">
            <strong>Physical Requirements:</strong> {{ tour.physical_requirements }}
          </div>
          <div class="detail-item" *ngIf="tour.languages_supported?.length">
            <strong>Supported Languages:</strong> {{ tour.languages_supported?.join(', ') }}
          </div>
          <div class="detail-item" *ngIf="tour.meals_included?.length">
            <strong>Meals Included:</strong> {{ tour.meals_included?.join(', ') }}
          </div>
          <div class="detail-item" *ngIf="tour.dietary_restrictions_supported?.length">
            <strong>Dietary Restrictions:</strong> {{ tour.dietary_restrictions_supported?.join(', ') }}
          </div>
          <div class="detail-item" *ngIf="tour.flight_included != null">
            <strong>Flights:</strong> {{ tour.flight_included ? 'Included' : 'Not Included' }}
          </div>
          <div class="detail-item" *ngIf="tour.instant_booking != null">
            <strong>Instant Booking:</strong> {{ tour.instant_booking ? 'Available' : 'Not Available' }}
          </div>
          <div class="detail-item" *ngIf="tour.requires_approval != null">
            <strong>Requires Approval:</strong> {{ tour.requires_approval ? 'Yes' : 'No' }}
          </div>
        </div>
      </div>

      <div class="inclusions-section">
        <div class="tabs-container">
          <div class="inclusion-tabs">
            <button class="tab-btn" [class.active]="inclusionTab === 'inclusions'" (click)="inclusionTab = 'inclusions'">Inclusions</button>
            <button class="tab-btn" [class.active]="inclusionTab === 'exclusions'" (click)="inclusionTab = 'exclusions'">Exclusions</button>
            <button class="tab-btn" [class.active]="inclusionTab === 'complementaries'" (click)="inclusionTab = 'complementaries'">Complementaries</button>
          </div>
        </div>
        <div class="inclusion-content">
          <div *ngIf="inclusionTab === 'inclusions'" class="inclusion-list">
            <div class="inclusion-item" *ngFor="let inclusion of tour.inclusions">
              <i class="icon-check"></i>
              <span>{{ inclusion }}</span>
            </div>
            <div class="inclusion-item" *ngIf="!tour.inclusions?.length">
              <span>No inclusions available</span>
            </div>
          </div>
          <div *ngIf="inclusionTab === 'exclusions'" class="inclusion-list">
            <div class="inclusion-item" *ngFor="let exclusion of tour.exclusions">
              <i class="icon-close"></i>
              <span>{{ exclusion }}</span>
            </div>
            <div class="inclusion-item" *ngIf="!tour.exclusions?.length">
              <span>No exclusions available</span>
            </div>
          </div>
          <div *ngIf="inclusionTab === 'complementaries'" class="inclusion-list">
            <div class="inclusion-item" *ngFor="let comp of tour.complementaries">
              <i class="icon-check"></i>
              <span>{{ comp }}</span>
            </div>
            <div class="inclusion-item" *ngIf="!tour.complementaries?.length">
              <span>No complementaries available</span>
            </div>
          </div>
        </div>
      </div>

      <div class="highlights-section">
        <h2>HIGHLIGHTS</h2>
        <div class="highlights-grid">
          <div class="highlight-item" *ngFor="let highlight of tour.highlights">
            <i class="icon-check"></i>
            <span>{{ highlight }}</span>
          </div>
          <div class="highlight-item" *ngIf="!tour.highlights?.length">
            <span>No highlights available</span>
          </div>
        </div>
      </div>

      <div class="policies-section">
        <h2>BOOKING POLICIES</h2>
        <div class="policy-item" *ngIf="tour.booking_terms">
          <strong>Booking Terms:</strong>
          <p>{{ tour.booking_terms }}</p>
        </div>
        <div class="policy-item" *ngIf="tour.cancellation_policy">
          <strong>Cancellation Policy:</strong>
          <p>{{ tour.cancellation_policy }}</p>
        </div>
        <div class="policy-item" *ngIf="!tour.booking_terms && !tour.cancellation_policy">
          <p>No booking policies available</p>
        </div>
      </div>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'itinerary'">
      <div class="itinerary-section">
        <h2>ITINERARY</h2>
        <div class="timeline">
          <div class="timeline-item" *ngFor="let day of getItineraryDays(); let i = index" [attr.aria-expanded]="openDayIndex === i" [attr.aria-controls]="'day-desc-' + i">
            <div class="day-number">Day {{ day.day || i + 1 }}</div>
            <div class="day-content" (click)="toggleDay(i)" role="button" tabindex="0" (keydown)="onKeydown($event, i)">
              <div class="day-header">
                <h4>{{ day.title || 'Day ' + (i + 1) }}</h4>
                <span class="toggle-icon" [class.open]="openDayIndex === i"></span>
              </div>
              <div class="day-description" [class.open]="openDayIndex === i" [id]="'day-desc-' + i">
                <p>{{ day.description || 'No description available' }}</p>
                <div *ngIf="day.activities?.length">
                  <strong>Activities:</strong> {{ day.activities?.join(', ') }}
                </div>
                <div *ngIf="day.meals_included?.length">
                  <strong>Meals:</strong> {{ day.meals_included?.join(', ') }}
                </div>
                <div *ngIf="day.accommodation">
                  <strong>Accommodation:</strong> {{ day.accommodation }}
                </div>
              </div>
              <div class="day-teaser" *ngIf="openDayIndex !== i">
                <span>Click to view details</span>
              </div>
            </div>
          </div>
          <div class="timeline-item" *ngIf="!getItineraryDays().length">
            <p>No itinerary available</p>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'photos'">
      <div class="photos-section">
        <h2>PHOTOS</h2>
        <div class="photo-gallery">
          <div class="photo-item" *ngFor="let photo of tour.photos">
            <img [src]="photo.url" [alt]="photo.caption || 'Tour photo'" (click)="openPhotoModal(photo)">
            <div class="image-info">
              <span *ngIf="photo.caption">{{ photo.caption }}</span>
              <span *ngIf="photo.is_primary" class="badge badge-primary">Primary</span>
            </div>
          </div>
          <div class="photo-item" *ngIf="!tour.photos?.length">
            <span>No photos available</span>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'map'">
      <div class="map-section">
        <h2>MAP</h2>
        <div class="map-container" *ngIf="tour.map_embed_url">
          <iframe [src]="sanitizer.bypassSecurityTrustResourceUrl(tour.map_embed_url)" width="100%" height="400" frameborder="0" allowfullscreen>
          </iframe>
        </div>
        <div *ngIf="!tour.map_embed_url">
          <p>No map available</p>
        </div>
      </div>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'reviews'">
      <div class="reviews-section">
        <h2>REVIEWS</h2>
        <div class="review-item" *ngFor="let review of tour.reviews">
          <div class="reviewer-info">
            <strong>{{ review.reviewer_name || 'Anonymous' }}</strong>
            <div class="rating">
              <span *ngFor="let star of getStarArray(review.rating)">★</span>
            </div>
          </div>
          <p>{{ review.comment || 'No comment available' }}</p>
          <small>{{ review.date | date }}</small>
        </div>
        <div class="review-item" *ngIf="!tour.reviews?.length">
          <p>No reviews available</p>
        </div>
      </div>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'info'">
      <div class="info-section">
        <h2>ADDITIONAL INFORMATION</h2>
        <div class="info-grid">
          <div class="info-item" *ngIf="tour.best_time_to_visit">
            <strong>Best Time to Visit:</strong> {{ tour.best_time_to_visit }}
          </div>
          <div class="info-item" *ngIf="tour.weather_info">
            <strong>Weather Information:</strong> {{ tour.weather_info }}
          </div>
          <div class="info-item" *ngIf="tour.packing_list?.length">
            <strong>Packing List:</strong>
            <ul>
              <li *ngFor="let item of tour.packing_list">{{ item }}</li>
            </ul>
          </div>
          <div class="info-item" *ngIf="tour.room_types?.length">
            <strong>Room Types:</strong>
            <ul>
              <li *ngFor="let room of tour.room_types">
                {{ room.name }} (Max Occupancy: {{ room.max_occupancy }})
                <span *ngIf="room.description"> - {{ room.description }}</span>
              </li>
            </ul>
          </div>
          <div class="info-item" *ngIf="!tour.best_time_to_visit && !tour.weather_info && !tour.packing_list?.length && !tour.room_types?.length">
            <p>No additional information available</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div *ngIf="loading" class="loading">
  <div class="spinner"></div>
  <p>Loading tour details...</p>
</div>

<app-booking-modal [isOpen]="isModalOpen" [formType]="modalFormType" [tour]="tour" (close)="closeModal()" (onSubmitEnquiry)="handleEnquirySubmit($event)" (onSubmitBooking)="handleBookingSubmit($event)"></app-booking-modal>

<app-chat-widget></app-chat-widget>
<app-footer></app-footer>